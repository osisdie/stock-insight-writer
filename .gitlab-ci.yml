stages:
  - lint
  - test
  - security
  - build

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHON_VERSION: "3.14.2"

cache:
  paths:
    - .cache/pip

.python-setup:
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - python -m pip install --upgrade pip

lint:
  extends: .python-setup
  stage: lint
  script:
    - pip install ruff
    - ruff check .
    - ruff format --check .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "web"

test:
  extends: .python-setup
  stage: test
  needs: [lint]
  script:
    - pip install -e ".[dev]"
    - pytest tests/ -v --tb=short
  variables:
    OPENROUTER_API_KEY: "sk-test-dummy-key-for-ci"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "web"

security:
  extends: .python-setup
  stage: security
  script:
    - pip install pip-audit
    - pip install -e .
    - pip-audit --strict || true
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:
  extends: .python-setup
  stage: build
  needs: [lint, test]
  script:
    - pip install build
    - python -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "web"
